<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div x-data="{count:1}">
      <h1 x-text="count"></h1>
      <button @mouseenter="count++">+</button>
      <button @click="count--">-</button>
    </div>
    <script>
      function getRawData() {
        let dataStringObj = root.getAttribute("x-data");
        return eval(`(${dataStringObj})`);
      }
      function refreshDom() {
        iterateDomNodes(root, (el) => {
          //each root's element will iterate here
          Array.from(el.attributes).forEach((attribute) => {
            if (!Object.keys(directives).includes(attribute.name)) return;
            directives[attribute.name](el, attribute.value);
          });
        });
      }
      function iterateDomNodes(el, callback) {
        callback(el);
        el = el.firstElementChild;
        while (el) {
          iterateDomNodes(el, callback);
          el = el.nextElementSibling; //last dom tree sibling will be null,so the loop will stop
        }
      }
      function getReactiveData(rawData) {
        return new Proxy(rawData, {
          set(rawData, key, value) {
            rawData[key] = value;
            refreshDom();
          },
        }); //when data change it call proxy set fucntion and update rawData
      }
      function listenEvents() {
        iterateDomNodes(root, (el) => {
          Array.from(el.attributes).forEach((attribute) => {
            if (!attribute.name.startsWith("@")) return;

            let event = attribute.name.replace("@", "");

            el.addEventListener(event, () => {
              eval(`with(data) ${attribute.value}`);
            });
          });
        });
      }
      let root = document.querySelector("[x-data]");
      let rawData = getRawData();
      let data = getReactiveData(rawData);
      //define directives here
      let directives = {
        "x-text": function (el, value) {
          el.innerHTML = eval(`with (rawData) ${value}`); //get rawData scope and call like a variable
        },
      };
      refreshDom(); //initial refresh
      listenEvents();
    </script>
  </body>
</html>
